import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createMenu, updateMenu, deleteMenu, toggleMenuSoldout } from './menuService';
import { collection, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'firebase/firestore';

// Mock dependencies
vi.mock('../lib/firebase', () => ({
    db: {},
}));

vi.mock('firebase/firestore', async () => {
    const actual = await vi.importActual('firebase/firestore');
    return {
        ...actual,
        collection: vi.fn(),
        addDoc: vi.fn(),
        updateDoc: vi.fn(),
        deleteDoc: vi.fn(),
        doc: vi.fn(),
        serverTimestamp: vi.fn(() => 'MOCK_TIMESTAMP'),
        query: vi.fn(),
        where: vi.fn(),
        orderBy: vi.fn(),
    };
});

describe('menuService', () => {
    const mockStoreId = 'store_123';
    const mockMenuId = 'menu_xyz';

    beforeEach(() => {
        vi.clearAllMocks();
    });

    describe('createMenu', () => {
        it('should create menu with timestamp', async () => {
            const mockDocRef = { id: 'new_menu_id' };
            (addDoc as any).mockResolvedValue(mockDocRef);
            (collection as any).mockReturnValue('MOCK_COLLECTION_REF');

            const menuData = {
                name: 'Pho',
                price: 10000,
                category: ['Noodle'], // Correct as string[]
                description: 'Delicious',
                imageUrl: 'http://example.com/img.jpg',
                isBest: true,
                soldout: false,
                options: []
            };

            const result = await createMenu(mockStoreId, menuData);

            expect(collection).toHaveBeenCalledWith(expect.anything(), 'stores', mockStoreId, 'menus');
            expect(addDoc).toHaveBeenCalledWith('MOCK_COLLECTION_REF', {
                ...menuData,
                createdAt: 'MOCK_TIMESTAMP',
            });
            expect(result).toBe('new_menu_id');
        });
    });

    describe('updateMenu', () => {
        it('should update menu fields and timestamp', async () => {
            (doc as any).mockReturnValue('MOCK_DOC_REF');

            await updateMenu(mockStoreId, mockMenuId, { price: 12000 });

            expect(doc).toHaveBeenCalledWith(expect.anything(), 'stores', mockStoreId, 'menus', mockMenuId);
            expect(updateDoc).toHaveBeenCalledWith('MOCK_DOC_REF', {
                price: 12000,
                updatedAt: 'MOCK_TIMESTAMP',
            });
        });
    });

    describe('deleteMenu', () => {
        it('should delete menu document', async () => {
            (doc as any).mockReturnValue('MOCK_DOC_REF');

            await deleteMenu(mockStoreId, mockMenuId);

            expect(deleteDoc).toHaveBeenCalledWith('MOCK_DOC_REF');
        });
    });

    describe('toggleMenuSoldout', () => {
        it('should update soldout status and timestamp', async () => {
            (doc as any).mockReturnValue('MOCK_DOC_REF');

            await toggleMenuSoldout(mockStoreId, mockMenuId, true);

            expect(updateDoc).toHaveBeenCalledWith('MOCK_DOC_REF', {
                soldout: true,
                updatedAt: 'MOCK_TIMESTAMP',
            });
        });
    });
});
